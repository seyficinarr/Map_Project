<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ispark Map</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
    <script src="https://js.arcgis.com/4.28/"></script>

</head>

<body>
    <div id="filterDiv">
        <button class="toggleButton" id="toggleFilter">+</button>
        <div class="icon">⚙️</div>
        <div class="content">
            <label for="districtFilter">Filter by Counties:</label>
            <select id="districtFilter" multiple>
            </select>
            <label for="singledistrictFilter">Or select a single district:</label>
            <input type="text" id="singledistrictFilter" placeholder="Enter district name">
        </div>
    </div>

    <div id="closestIspark">
        <button id="closestIsparkButton">Get the Closest Ispark</button>
        
    </div>

    <div id="allIsparks">
        <button id="showAllIsparks">Show All Isparks</button>
        
    </div>

    <div id="viewDiv"></div>

    <div id="map_explainer">
        <p style="color:green"><strong>Green Color: The park is available.</strong></p>
        <p style="color:red"><strong>Red Color: The park is full.</strong></p>
        <p style="color:gray"><strong>Gray Color: The park is closed at the moment.</strong></p>
    </div>

    <div id="info">
        <h2>Info</h2>
        <p>Number of isparks found: {{count}}</p>
    </div>

    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/Graphic",
            "esri/layers/GraphicsLayer",
            "esri/widgets/Locate",
            "esri/layers/GeoJSONLayer",
            "esri/geometry/Point",
            "esri/geometry/geometryEngine",
            "esri/geometry/support/webMercatorUtils",
            "esri/symbols/PictureMarkerSymbol"
        ], function (Map, MapView, Graphic, GraphicsLayer, Locate, GeoJSONLayer, Point, geometryEngine, webMercatorUtils, PictureMarkerSymbol) {

            const isparks = {{ isparks| tojson
        }};

        // Create the map and view
        const map = new Map({
            basemap: "topo-vector"
        });

        const view = new MapView({
            container: "viewDiv",
            map: map,
            center: [28.9754, 41.0082],
            zoom: 12
        });

        const graphicsLayer = new GraphicsLayer();
        map.add(graphicsLayer);

        let allGraphics = [];
        let currentLatitude = null;
        let currentLongitude = null;

        getCurrentLocation((lat, lng) => {
            if (lat !== null && lng !== null) {
                currentLatitude = lat;
                currentLongitude = lng;
            }
        });

        function addGraphics() {
            allGraphics.forEach(graphic => graphicsLayer.remove(graphic));
            graphicsLayer.removeAll();
            let count = 0;
            const graphicPromises = isparks.map((ispark, index) => {
                count++;
                const point = {
                    type: "point",
                    longitude: ispark.lng,
                    latitude: ispark.lat
                };

                const pointGraphic = new Graphic({
                    geometry: point,
                    symbol: {
                        type: "simple-marker",
                        color: selectColor(ispark.id),
                        size: 8
                    },
                    attributes: {
                        name: ispark.name,
                        description: ispark.park_type,
                        district: ispark.district,
                        lat: ispark.lat,
                        lon: ispark.lng
                    },
                    popupTemplate: {
                        title: "{name}",
                        content: `
                <b>Distance:</b> ${getDistance(ispark.lat, ispark.lng)} kilometers away<br>
                <b>Park Type:</b> {description}<br>
                <b>District:</b> {district}<br>
                <a href="http://127.0.0.1:5000/ispark/${ispark.id}" target="_blank">Detailed Information</a><br>
                <a href="https://www.google.com/maps?q={lat},{lon}" target="_blank">Get Direction</a>
            `
                    }
                });
                graphicsLayer.add(pointGraphic);
                allGraphics.push(pointGraphic);

            });

            // Wait for all promises to resolve before updating the count
            Promise.all(graphicPromises).then(() => {
                document.getElementById('info').innerHTML = `<p>Number of isparks found: ${count}</p>`;
            });
        }

        document.getElementById("closestIsparkButton").addEventListener("click", getClosestIspark);
        document.getElementById("showAllIsparks").addEventListener("click", showAllIsparks);

        function getClosestIspark() {
            let distance = Infinity;
            let closestIspark = null;

            isparks.forEach(ispark => {
                const isparkLat = ispark.lat;
                const isparkLng = ispark.lng;
                const currentDistance = haversineDistance(isparkLat, isparkLng, currentLatitude, currentLongitude);
                if (currentDistance < distance) {
                    closestIspark = ispark;
                    distance = currentDistance;
                }
            });
            const point = new Point({
                longitude: closestIspark.lng,
                latitude: closestIspark.lat
            });

            // Create a Graphic for the marker
            const markerSymbol = {
                type: "picture-marker",
                url: "static/images/image copy 3.png",
                width: "48px",
                height: "48px",
                anchor: "bottom",
                yoffset: 20
            };

            console.log(markerSymbol);



            const pointGraphic = new Graphic({
                geometry: point,
                symbol: markerSymbol,
                popupTemplate: {
                    title: "Closest Ispark",
                    content: `
                <b>Name:</b> ${closestIspark.name}<br>
                <b>Distance:</b> ${distance.toFixed(2)} kilometers away<br>
                <b>Park Type:</b> {closestIspark.park_type}<br>
                <b>District:</b> {closestIspark.district}<br>
                <a href="http://127.0.0.1:5000/ispark/${closestIspark.id}" target="_blank">Detailed Information</a><br>
                <a href="https://www.google.com/maps?q={closestIspark.lat},{closestIspark.lng}" target="_blank">Get Direction</a>
            `
                }
            });

            // Add the marker Graphic to the GraphicsLayer
            graphicsLayer.add(pointGraphic);
            console.log(closestIspark.lat + "," + closestIspark.lng)
            view.center = [closestIspark.lng, closestIspark.lat];
            view.zoom = [14];
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in kilometers
        }

        function toRad(degrees) {
            return degrees * (Math.PI / 180);
        }

        function normalizeString(str) {
            // Replace Turkish-specific characters
            return str
                .replace(/ç/g, 'c')
                .replace(/Ç/g, 'C')
                .replace(/ı/g, 'i')
                .replace(/İ/g, 'I')
                .replace(/ğ/g, 'g')
                .replace(/Ğ/g, 'G')
                .replace(/ö/g, 'o')
                .replace(/Ö/g, 'O')
                .replace(/ş/g, 's')
                .replace(/Ş/g, 'S')
                .replace(/ü/g, 'u')
                .replace(/Ü/g, 'U')
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, ''); // Remove diacritical marks
        }

        function populatedistrictDropdown() {
            const counties = Array.from(new Set(isparks.map(ispark => ispark.district)));

            const select = document.getElementById('districtFilter');
            select.innerHTML = '';

            counties.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                select.appendChild(option);
            });
        }

        populatedistrictDropdown();

        function showAllIsparks(){
            let count = 0;
            for (const graph of allGraphics) {
                graph.visible = true;
                count++;
            }

            document.getElementById("info").innerHTML = `<p>Search for all isparks.</p>`;
            document.getElementById("info").innerHTML += `<p>Number of isparks found: ${count}</p>`;
        }

        function filterByCounties(selectedCounties) {
            let count = 0;

            for (const graph of allGraphics) {
                const district = normalizeString(graph.attributes.district);
                if (selectedCounties.some(selecteddistrict =>
                    normalizeString(selecteddistrict).toLowerCase().includes(district.toLowerCase())
                )) {
                    graph.visible = true;
                    count++;
                } else {
                    graph.visible = false;
                }
            }

            // Display the total count of isparks found
            document.getElementById("info").innerHTML = `<p>Search for selected areas</p>`;
            document.getElementById("info").innerHTML += `<p>Number of isparks found: ${count}</p>`;

        }

        function filterBySingledistrict(districtName) {
            const normalizeddistrictName = normalizeString(districtName);
            let count = 0;
            allGraphics.forEach(graphic => {
                const district = normalizeString(graphic.attributes.district);
                if (district.toLowerCase().includes(normalizeddistrictName.toLowerCase())) {
                    count++;
                    graphic.visible = true; // Show the graphic if it matches
                } else {
                    graphic.visible = false; // Hide the graphic if it doesn't match
                }
            });

            districtName = districtName.substring(0, 1).toUpperCase() + districtName.substring(1);
            document.getElementById('info').innerHTML = `<p>Selected district is: ${districtName}</p>`;
            document.getElementById('info').innerHTML += `<p>Number of isparks found: ${count}</p>`;
        }

        document.getElementById('districtFilter').addEventListener('change', function (event) {
            const selectedOptions = Array.from(event.target.selectedOptions).map(option => option.value);
            filterByCounties(selectedOptions);
        });

        document.getElementById('singledistrictFilter').addEventListener('input', function (event) {
            const districtName = event.target.value;
            filterBySingledistrict(districtName);
        });

        document.getElementById('toggleFilter').addEventListener('click', function () {
            const filterDiv = document.getElementById('filterDiv');
            filterDiv.classList.toggle('collapsed');
        });

        const locateWidget = new Locate({
            view: view,
            rotationEnabled: true
        });

        view.ui.add(locateWidget, "top-right");

        view.when(() => {
            locateWidget.locate(); // Programmatically trigger locate
        });

        locateWidget.on("locate", function (event) {
            view.zoom = 14;
        });

        // Add GeoJSON Layer
        const geojsonUrl = "/static/istanbul.json";

        const districtLayer = new GeoJSONLayer({

            url: geojsonUrl,
            renderer: {
                type: "simple",
                symbol: {
                    type: "simple-fill",
                    color: [0, 0, 0, 0], // Transparent fill color
                    outline: {
                        color: "green", // Color of the boundary lines
                        width: 2 // Width of the boundary lines
                    }
                }
            }
        });

        fetch(geojsonUrl)
            .then(response => response.json())
            .then(data => {
                geojsonData = data;
            }
            )

        map.add(districtLayer);

        view.whenLayerView(districtLayer).then(function (layerView) {
            let highlight;
            let debounceTimeout;

            view.on("pointer-move", function (event) {
                // Clear the previous timeout if it exists
                if (debounceTimeout) {
                    clearTimeout(debounceTimeout);
                }

                debounceTimeout = setTimeout(function () {
                    const screenPoint = { x: event.x, y: event.y };
                    view.hitTest(screenPoint).then(function (response) {
                        if (highlight) {
                            highlight.remove(); // Remove previous highlight
                        }

                        const feature = response.results.find(result => result.graphic.layer === districtLayer);
                        // Check if feature is found and log the result
                        if (feature) {

                            highlight = layerView.highlight(feature.graphic);

                            const id = feature.graphic.attributes.__OBJECTID;

                            ftr = getFeatureById(id);
                            let districtName = ftr.properties.name.toLowerCase();
                            districtName = districtName.toString();
                            districtName = districtName === "eyüpsultan" ? "eyüp" : districtName;
                            filterBySingledistrict(districtName);
                        } else {
                            layerView.highlight([]);
                        }
                    }).catch(function (error) {
                        // Handle errors in hitTest
                        console.error("Error in hitTest:", error);
                    });
                }, 100); // Adjust debounce delay if needed
            });

        });

        let isparks_data = [];

        // Fetch the JSON file and handle data
        async function fetchIsparkData() {
            try {
                const response = await fetch('https://api.ibb.gov.tr/ispark/Park');
                isparks_data = await response.json();
                // Once data is fetched, call any functions that depend on it here
                addGraphics(); // Call your function that relies on isparks_data here
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Call the function to fetch data
        fetchIsparkData();

        function defineIsparkStatus(id) {
            // Check if isparks_data is populated
            if (isparks_data.length === 0) {
                console.warn('isparks_data is not yet loaded.');
                return; // Or handle the case when data is not yet loaded
            }

            const ispark = isparks_data.find(result => result.parkID == id);
            if (ispark) {
                if (ispark.isOpen && ispark.emptyCapacity > 0) {
                    return 2;
                } else if (ispark.emptyCapacity == 0) {
                    return 1;
                } else {
                    return 0;
                }
            } else {
                console.warn('No ispark found with ID:', id);
                return; // Handle the case where no ispark is found
            }
        }

        function selectColor(id) {
            if (defineIsparkStatus(id) == 2) {
                return "green";
            } else if (defineIsparkStatus(id) == 1) {
                return "red";
            } else {
                return "gray";
            }
        }

        function getDistance(lat1, lng1) {

            const point1 = new Point({
                longitude: lng1,  // Longitude of the first point
                latitude: lat1,    // Latitude of the first point
                spatialReference: { wkid: 4326 }  // WGS84 spatial reference
            })

            const point2 = new Point({
                longitude: currentLongitude,  // Longitude of the first point
                latitude: currentLatitude,    // Latitude of the first point
                spatialReference: { wkid: 4326 }  // WGS84 spatial reference
            })




            const webMercatorPoint1 = webMercatorUtils.geographicToWebMercator(point1);
            const webMercatorPoint2 = webMercatorUtils.geographicToWebMercator(point2);

            const distance = geometryEngine.distance(webMercatorPoint1, webMercatorPoint2, "kilometers");
            const formattedValue = distance.toFixed(2);
            return formattedValue;
        }

        function getCurrentLocation(callback) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        callback(lat, lon);
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        callback(null, null);
                    }
                );
            } else {
                console.error('Geolocation is not supported by this browser.');
                callback(null, null);
            }
        }

        function getFeatureById(id) {
            return geojsonData.features.find(feature => feature.id === id);
        }
        });
    </script>
</body>

</html>